"use strict";function _slicedToArray(arr,i){return _arrayWithHoles(arr)||_iterableToArrayLimit(arr,i)||_unsupportedIterableToArray(arr,i)||_nonIterableRest()}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(o,minLen){if(o){if("string"==typeof o)return _arrayLikeToArray(o,minLen);var n=Object.prototype.toString.call(o).slice(8,-1);return"Map"===(n="Object"===n&&o.constructor?o.constructor.name:n)||"Set"===n?Array.from(o):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(o,minLen):void 0}}function _arrayLikeToArray(arr,len){(null==len||len>arr.length)&&(len=arr.length);for(var i=0,arr2=new Array(len);i<len;i++)arr2[i]=arr[i];return arr2}function _iterableToArrayLimit(arr,i){var _i=null==arr?null:"undefined"!=typeof Symbol&&arr[Symbol.iterator]||arr["@@iterator"];if(null!=_i){var _s,_e,_arr=[],_n=!0,_d=!1;try{for(_i=_i.call(arr);!(_n=(_s=_i.next()).done)&&(_arr.push(_s.value),!i||_arr.length!==i);_n=!0);}catch(err){_d=!0,_e=err}finally{try{_n||null==_i.return||_i.return()}finally{if(_d)throw _e}}return _arr}}function _arrayWithHoles(arr){if(Array.isArray(arr))return arr}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")}function _defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}function _createClass(Constructor,protoProps,staticProps){return protoProps&&_defineProperties(Constructor.prototype,protoProps),staticProps&&_defineProperties(Constructor,staticProps),Object.defineProperty(Constructor,"prototype",{writable:!1}),Constructor}function _typeof(obj){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(obj){return typeof obj}:function(obj){return obj&&"function"==typeof Symbol&&obj.constructor===Symbol&&obj!==Symbol.prototype?"symbol":typeof obj})(obj)}var __defProp=Object.defineProperty,__defNormalProp=function(obj,key,value){return key in obj?__defProp(obj,key,{enumerable:!0,configurable:!0,writable:!0,value:value}):obj[key]=value},__publicField=function(obj,key,value){return __defNormalProp(obj,"symbol"!==_typeof(key)?key+"":key,value),value},MobileSelect=function(){var MobileSelect2=function(){function _MobileSelect(config){_classCallCheck(this,_MobileSelect),__publicField(this,"mobileSelect"),__publicField(this,"trigger"),__publicField(this,"wheel"),__publicField(this,"slider"),__publicField(this,"wheels"),__publicField(this,"panel"),__publicField(this,"ensureBtn"),__publicField(this,"cancelBtn"),__publicField(this,"grayLayer"),__publicField(this,"popUp"),__publicField(this,"initPosition"),__publicField(this,"initColWidth"),__publicField(this,"connector"),__publicField(this,"wheelsData"),__publicField(this,"displayJson"),__publicField(this,"curValue"),__publicField(this,"curIndexArr"),__publicField(this,"isCascade"),__publicField(this,"isJsonType"),__publicField(this,"startY"),__publicField(this,"moveEndY"),__publicField(this,"moveY"),__publicField(this,"preMoveY"),__publicField(this,"offsetY"),__publicField(this,"offsetSum"),__publicField(this,"oversizeBorder"),__publicField(this,"enableClickStatus"),__publicField(this,"isPC"),__publicField(this,"optionHeight"),__publicField(this,"curDistance"),__publicField(this,"cascadeJsonData"),__publicField(this,"keyMap"),__publicField(this,"eventHandleMap"),__publicField(this,"initDeepCount"),__publicField(this,"config"),this.config=Object.assign(_MobileSelect.defaultConfig,config),this.wheelsData=config.wheels,this.isJsonType=!1,this.cascadeJsonData=[],this.displayJson=[],this.curValue=[],this.curIndexArr=[],this.isCascade=!1,this.startY,this.moveEndY,this.moveY,this.preMoveY,this.offsetY=0,this.offsetSum=0,this.oversizeBorder,this.curDistance=[],this.enableClickStatus=!1,this.isPC=!0,this.optionHeight=0,this.initPosition=config.position||[],this.initColWidth=config.colWidth||[],this.init()}return _createClass(_MobileSelect,[{key:"init",value:function(){var _this=this,config=this.config;if(this.isJsonType=_MobileSelect.checkDataType(this.wheelsData),this.renderComponent(this.wheelsData),"string"==typeof config.trigger?this.trigger=document.querySelector(config.trigger):this.trigger=config.trigger,this.trigger){if(this.wheel=this.mobileSelect.getElementsByClassName("ms-wheel"),this.slider=this.mobileSelect.getElementsByClassName("ms-select-container"),this.panel=this.mobileSelect.querySelector(".ms-panel"),this.wheels=this.mobileSelect.querySelector(".ms-wheels"),this.ensureBtn=this.mobileSelect.querySelector(".ms-ensure"),this.cancelBtn=this.mobileSelect.querySelector(".ms-cancel"),this.grayLayer=this.mobileSelect.querySelector(".ms-gray-layer"),this.popUp=this.mobileSelect.querySelector(".ms-content"),this.optionHeight=this.mobileSelect.querySelector("li").offsetHeight,config.initValue&&config.triggerDisplayValue&&(this.trigger.innerText=config.initValue),this.setStyle(config),this.isPC=_MobileSelect.checkIsPC(),this.isCascade=this.checkCascade(),this.isCascade&&this.initCascade(),config.initValue&&(this.initPosition=this.getPositionByValue()),this.initPosition.length<this.slider.length)for(var diff=this.slider.length-this.initPosition.length,i=0;i<diff;i++)this.initPosition.push(0);this.setCurDistance(this.initPosition),this.eventHandleMap={cancelBtn:{event:"click",fn:function(){var _b,_a;_this.hide(),null!=(_b=(_a=_this.config).cancel)&&_b.call(_a,_this.curIndexArr,_this.curValue),null!=(_a=(_b=_this.config).onCancel)&&_a.call(_b,_this.curIndexArr,_this.curValue)}},ensureBtn:{event:"click",fn:function(){_this.hide(),_this.optionHeight||(_this.optionHeight=_this.mobileSelect.querySelector("li").offsetHeight);for(var _b,_a,tempValue="",_i=0;_i<_this.wheel.length;_i++)_i==_this.wheel.length-1?tempValue+=_this.getInnerHtml(_i):tempValue+=_this.getInnerHtml(_i)+_this.config.connector;config.triggerDisplayValue&&(_this.trigger.innerText=tempValue),_this.curIndexArr=_this.getIndexArr(),_this.curValue=_this.getCurValue(),null!=(_b=(_a=_this.config).callback)&&_b.call(_a,_this.curIndexArr,_this.curValue),null!=(_a=(_b=_this.config).onChange)&&_a.call(_b,_this.curIndexArr,_this.curValue)}},trigger:{event:"click",fn:function(){_this.show()}},grayLayer:{event:"click",fn:function(){return _this.hide()}},popUp:{event:"click",fn:function(event){return event.stopPropagation()}},panel:{event:["touchstart","touchend","touchmove"],fn:function(event){return _this.touch(event)}}},this.isPC&&(this.eventHandleMap.panel.event=["mousedown","mousemove","mouseup"]),this.registerEvents("add"),this.fixRowStyle()}else console.error("mobile-select has been successfully installed, but no trigger found on your page.")}},{key:"getPositionByValue",value:function(){var childList,_this2=this,_this$config=this.config,keyMap=_this$config.keyMap,connector=_this$config.connector,_this$config=_this$config.initValue,_this$config=(null==_this$config?void 0:_this$config.split(connector))||[];return this.isJsonType?(childList=null==(connector=this.wheelsData[0])?void 0:connector.data,_this$config.reduce(function(result,cur){var posIndex=null==childList?void 0:childList.findIndex(function(item){return item[keyMap.value]==cur});return result.push(posIndex<0?0:posIndex),childList=null==(posIndex=childList[posIndex])?void 0:posIndex[keyMap.childs],result},[])):_this$config.reduce(function(result,cur,index){index=null==(index=null==(index=_this2.wheelsData[index])?void 0:index.data)?void 0:index.findIndex(function(item){return item==cur});return result.push(index<0?0:index),result},[])}},{key:"setTitle",value:function(title){this.mobileSelect.querySelector(".ms-title").innerHTML=title}},{key:"setStyle",value:function(config){var shadowMask;config.ensureBtnColor&&(this.ensureBtn.style.color=config.ensureBtnColor),config.cancelBtnColor&&(this.cancelBtn.style.color=config.cancelBtnColor),config.titleColor&&(this.mobileSelect.querySelector(".ms-title").style.color=config.titleColor),config.textColor&&(this.panel=this.mobileSelect.querySelector(".ms-panel"),this.panel.style.color=config.textColor),config.titleBgColor&&(this.mobileSelect.querySelector(".ms-btn-bar").style.backgroundColor=config.titleBgColor),config.bgColor&&(this.panel=this.mobileSelect.querySelector(".ms-panel"),shadowMask=this.mobileSelect.querySelector(".ms-shadow-mask"),this.panel.style.backgroundColor=config.bgColor,shadowMask.style.background="linear-gradient(to bottom, "+config.bgColor+", rgba(255, 255, 255, 0), "+config.bgColor+")"),"number"==typeof config.maskOpacity&&(this.mobileSelect.querySelector(".ms-gray-layer").style.background="rgba(0, 0, 0, "+config.maskOpacity+")")}},{key:"show",value:function(){var _a,_b;this.mobileSelect.classList.add("ms-show"),"function"==typeof this.config.onShow&&null!=(_b=(_a=this.config).onShow)&&_b.call(_a)}},{key:"hide",value:function(){var _a,_b;this.mobileSelect.classList.remove("ms-show"),"function"==typeof this.config.onHide&&null!=(_b=(_a=this.config).onHide)&&_b.call(_a)}},{key:"registerEvents",value:function(type){for(var _this3=this,_i2=0,_Object$entries=Object.entries(this.eventHandleMap);_i2<_Object$entries.length;_i2++)!function(){var _Object$entries$_i=_slicedToArray(_Object$entries[_i2],2),domName=_Object$entries$_i[0],item=_Object$entries$_i[1];"string"==typeof item.event?_this3[domName]["".concat(type,"EventListener")](item.event,item.fn):item.event.forEach(function(eventName){_this3[domName]["".concat(type,"EventListener")](eventName,item.fn)})}()}},{key:"destroy",value:function(){this.registerEvents("remove"),this.mobileSelect.parentNode.removeChild(this.mobileSelect)}},{key:"getOptionsHtmlStr",value:function(childs){var keyMap=this.config.keyMap,tempHTML="";if(this.isJsonType)for(var j=0;j<childs.length;j++){var id=childs[j][keyMap.id],val=childs[j][keyMap.value];tempHTML+='<li data-id="'.concat(id,'">').concat(val,"</li>")}else for(var _j=0;_j<childs.length;_j++)tempHTML+="<li>"+childs[_j]+"</li>";return tempHTML}},{key:"renderComponent",value:function(wheelsData){this.mobileSelect=document.createElement("div"),this.mobileSelect.className="ms-mobile-select",this.mobileSelect.innerHTML='<div class="ms-gray-layer"></div>\n        <div class="ms-content">\n          <div class="ms-btn-bar">\n            <div class="ms-fix-width">\n              <div class="ms-cancel">'.concat(this.config.cancelBtnText||"取消",'</div>  \n              <div class="ms-title">').concat(this.config.title||"",'</div>\n              <div class="ms-ensure">').concat(this.config.ensureBtnText||"确认",'</div>\n            </div>\n          </div>\n          <div class="ms-panel">\n            <div class="ms-fix-width">\n            <div class="ms-wheels"></div>\n            <div class="ms-select-line"></div>\n            <div class="ms-shadow-mask"></div>\n          </div>\n        </div>'),document.body.appendChild(this.mobileSelect);for(var tempHTML="",i=0;i<wheelsData.length;i++)tempHTML=(tempHTML+='<div class="ms-wheel"><ul class="ms-select-container" data-index="'.concat(i,'">'))+this.getOptionsHtmlStr(wheelsData[i].data)+"</ul></div>";this.mobileSelect.querySelector(".ms-wheels").innerHTML=tempHTML}},{key:"reRenderWheels",value:function(){var diff=this.wheel.length-this.displayJson.length;if(0<diff)for(var i=0;i<diff;i++)this.wheels.removeChild(this.wheel[this.wheel.length-1]);for(var tempWheel,_i3=0;_i3<this.displayJson.length;_i3++)this.wheel[_i3]?this.slider[_i3].innerHTML=this.getOptionsHtmlStr(this.displayJson[_i3]):((tempWheel=document.createElement("div")).className="ms-wheel",tempWheel.innerHTML='<ul class="ms-select-container" data-index="'.concat(_i3,'">').concat(this.getOptionsHtmlStr(this.displayJson[_i3]),"</ul>"),this.wheels.appendChild(tempWheel))}},{key:"checkCascade",value:function(){var _a,keyMap=this.config.keyMap;if(this.isJsonType)for(var node=this.wheelsData[0].data,i=0;i<node.length;i++)if(keyMap.childs in node[i]&&0<(null==(_a=node[i][keyMap.childs])?void 0:_a.length))return this.cascadeJsonData=this.wheelsData[0].data,!0;return!1}},{key:"initCascade",value:function(){this.displayJson.push(this.cascadeJsonData),0<this.initPosition.length?(this.initDeepCount=0,this.initCheckArrDeep(this.cascadeJsonData[this.initPosition[0]])):this.checkArrDeep(this.cascadeJsonData[0]),this.reRenderWheels()}},{key:"initCheckArrDeep",value:function(parent){var keyMap,nextNode;parent&&(keyMap=this.config.keyMap).childs in parent&&0<parent[keyMap.childs].length&&(this.displayJson.push(parent[keyMap.childs]),this.initDeepCount++,(nextNode=parent[keyMap.childs][this.initPosition[this.initDeepCount]])?this.initCheckArrDeep(nextNode):this.checkArrDeep(parent[keyMap.childs][0]))}},{key:"checkArrDeep",value:function(parent){var keyMap;!parent||(keyMap=this.config.keyMap).childs in parent&&0<parent[keyMap.childs].length&&(this.displayJson.push(parent[keyMap.childs]),this.checkArrDeep(parent[keyMap.childs][0]))}},{key:"checkRange",value:function(index,posIndexArr){for(var _a,resultNode,deleteNum=this.displayJson.length-1-index,keyMap=this.config.keyMap,i=0;i<deleteNum;i++)this.displayJson.pop();for(var _i4=0;_i4<=index;_i4++)resultNode=0==_i4?this.cascadeJsonData[posIndexArr[0]]:null==(_a=null==resultNode?void 0:resultNode[keyMap.childs])?void 0:_a[posIndexArr[_i4]];this.checkArrDeep(resultNode),this.reRenderWheels(),this.fixRowStyle(),this.setCurDistance(this.resetPosition(index,posIndexArr))}},{key:"resetPosition",value:function(index,posIndexArr){var tempPosArr=posIndexArr;if(this.slider.length>posIndexArr.length)for(var tempCount=this.slider.length-posIndexArr.length,i=0;i<tempCount;i++)tempPosArr.push(0);else if(this.slider.length<posIndexArr.length){tempCount=posIndexArr.length-this.slider.length;for(var _i5=0;_i5<tempCount;_i5++)tempPosArr.pop()}for(var _i6=index+1;_i6<tempPosArr.length;_i6++)tempPosArr[_i6]=0;return tempPosArr}},{key:"updateWheels",value:function(data){if(this.isCascade){if(this.cascadeJsonData=data,this.displayJson=[],this.initCascade(),this.initPosition.length<this.slider.length)for(var diff=this.slider.length-this.initPosition.length,i=0;i<diff;i++)this.initPosition.push(0);this.setCurDistance(this.initPosition),this.fixRowStyle()}}},{key:"updateWheel",value:function(sliderIndex,data){var tempHTML="";this.isCascade?console.error("级联格式不支持updateWheel(),请使用updateWheels()更新整个数据源"):(tempHTML+=this.getOptionsHtmlStr(data),this.wheelsData[sliderIndex]=this.isJsonType?{data:data}:data,this.slider[sliderIndex].innerHTML=tempHTML)}},{key:"fixRowStyle",value:function(){var widthSum,_this4=this;if(this.initColWidth.length&&this.initColWidth.length===this.wheel.length)widthSum=this.initColWidth.reduce(function(cur,pre){return cur+pre},0),this.initColWidth.forEach(function(item,index){_this4.wheel[index].style.width=(item/widthSum*100).toFixed(2)+"%"});else for(var width=(100/this.wheel.length).toFixed(2),i=0;i<this.wheel.length;i++)this.wheel[i].style.width=width+"%"}},{key:"getIndex",value:function(distance){return Math.round((2*this.optionHeight-distance)/this.optionHeight)}},{key:"getIndexArr",value:function(){for(var temp=[],i=0;i<this.curDistance.length;i++)temp.push(this.getIndex(this.curDistance[i]));return temp}},{key:"getCurValue",value:function(){var temp=[],positionArr=this.getIndexArr();if(this.isCascade)for(var i=0;i<this.wheel.length;i++)temp.push(this.displayJson[i][positionArr[i]]);else if(this.isJsonType)for(var _i7=0;_i7<this.curDistance.length;_i7++)temp.push(this.wheelsData[_i7].data[this.getIndex(this.curDistance[_i7])]);else for(var _i8=0;_i8<this.curDistance.length;_i8++)temp.push(this.getInnerHtml(_i8));return temp}},{key:"getValue",value:function(){return this.curValue}},{key:"calcDistance",value:function(index){return 2*this.optionHeight-index*this.optionHeight}},{key:"setCurDistance",value:function(indexArr){for(var temp=[],i=0;i<this.slider.length;i++)temp.push(this.calcDistance(indexArr[i])),this.movePosition(this.slider[i],temp[i]);this.curDistance=temp}},{key:"fixPosition",value:function(distance){return-(this.getIndex(distance)-2)*this.optionHeight}},{key:"movePosition",value:function(theSlider,distance){theSlider.style.transform="translate3d(0,"+distance+"px, 0)"}},{key:"locatePosition",value:function(index,posIndex){this.curDistance[index]=this.calcDistance(posIndex),this.movePosition(this.slider[index],this.curDistance[index]),this.isCascade&&this.checkRange(index,this.getIndexArr())}},{key:"updateCurDistance",value:function(theSlider,index){this.curDistance[index]=parseInt(theSlider.style.transform.split(",")[1])}},{key:"getInnerHtml",value:function(sliderIndex){var lengthOfList=this.slider[sliderIndex].getElementsByTagName("li").length,index=this.getIndex(this.curDistance[sliderIndex]);return lengthOfList<=index?index=lengthOfList-1:index<0&&(index=0),this.slider[sliderIndex].getElementsByTagName("li")[index].innerHTML}},{key:"touch",value:function(event){var _b,clickOffetNum,_this5=this,theSlider=(event.composedPath&&event.composedPath())[1],index=parseInt(theSlider.getAttribute("data-index")||"0");switch(event.type){case"touchstart":case"mousedown":this.startY=Math.floor((event instanceof TouchEvent?event.touches[0]:event).clientY),this.preMoveY=this.startY,"mousedown"===event.type&&(this.enableClickStatus=!0);break;case"touchend":case"mouseup":this.moveEndY=Math.floor((event instanceof TouchEvent?event.changedTouches[0]:event).clientY),this.offsetSum=this.moveEndY-this.startY,this.oversizeBorder=-(theSlider.getElementsByTagName("li").length-3)*this.optionHeight,0==this.offsetSum?2!=(clickOffetNum=Math.floor((document.documentElement.clientHeight-this.moveEndY)/40))&&(clickOffetNum=this.curDistance[index]+(clickOffetNum-2)*this.optionHeight)<=2*this.optionHeight&&clickOffetNum>=this.oversizeBorder&&(this.curDistance[index]=clickOffetNum,this.movePosition(theSlider,this.curDistance[index]),null!=(_b=(clickOffetNum=this.config).transitionEnd)&&_b.call(clickOffetNum,this.getIndexArr(),this.getCurValue()),null!=(clickOffetNum=(_b=this.config).onTransitionEnd)&&clickOffetNum.call(_b,this.getIndexArr(),this.getCurValue())):(this.updateCurDistance(theSlider,index),this.curDistance[index]=this.fixPosition(this.curDistance[index]),this.movePosition(theSlider,this.curDistance[index]),this.curDistance[index]+this.offsetSum>2*this.optionHeight?(this.curDistance[index]=2*this.optionHeight,setTimeout(function(){_this5.movePosition(theSlider,_this5.curDistance[index])},100)):this.curDistance[index]+this.offsetSum<this.oversizeBorder&&(this.curDistance[index]=this.oversizeBorder,setTimeout(function(){_this5.movePosition(theSlider,_this5.curDistance[index])},100)),null!=(_b=(clickOffetNum=this.config).transitionEnd)&&_b.call(clickOffetNum,this.getIndexArr(),this.getCurValue()),null!=(clickOffetNum=(_b=this.config).onTransitionEnd)&&clickOffetNum.call(_b,this.getIndexArr(),this.getCurValue())),"mouseup"===event.type&&(this.enableClickStatus=!1),this.isCascade&&this.checkRange(index,this.getIndexArr());break;case"touchmove":case"mousemove":if(event.preventDefault(),"mousemove"===event.type&&!this.enableClickStatus)break;this.moveY=Math.floor((event instanceof TouchEvent?event.touches[0]:event).clientY),this.offsetY=this.moveY-this.preMoveY,this.updateCurDistance(theSlider,index),this.curDistance[index]=this.curDistance[index]+this.offsetY,this.movePosition(theSlider,this.curDistance[index]),this.preMoveY=this.moveY}}}],[{key:"checkIsPC",value:function(){return!Boolean(navigator.userAgent.toLowerCase().match(/ipad|iphone os|midp|rv:1.2.3.4|ucweb|android|windows ce|windows mobile/))}},{key:"checkDataType",value:function(wheelsData){return"object"===_typeof(null==(wheelsData=null==(wheelsData=wheelsData[0])?void 0:wheelsData.data)?void 0:wheelsData[0])}}]),_MobileSelect}();return __publicField(MobileSelect2,"defaultConfig",{keyMap:{id:"id",value:"value",childs:"childs"},position:[],colWidth:[],title:"",connector:" ",ensureBtnText:"确认",cancelBtnText:"取消",triggerDisplayValue:!0}),MobileSelect2}();